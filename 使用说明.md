# BVRGym 使用说明

## 📁 项目结构

```
BVRGym/
├── main_multi_f16.py          # 主入口：多架F16编队仿真
├── main_F16_run_viz.py        # 单架F16可视化仿真
├── UtilsLib/
│   ├── fleet.py               # Fleet类：管理多架飞机
│   ├── aircraft_unit.py       # AircraftUnit类：单架飞机封装
│   ├── fixwing_visualizer_3D.py  # 3D可视化类
│   ├── position_control.py   # 位置控制器
│   └── Tools.py               # 工具函数（NED坐标转换等）
└── jsb_gym/
    └── TAU/
        ├── aircraft2.py       # F16飞行动力学模型
        └── config/
            └── f16_traj_track.py  # 配置文件
```

## 🚀 代码运行流程

### 方式1：多架F16编队仿真（推荐）

```bash
python main_multi_f16.py
```

**运行流程：**

1. **初始化** (`Fleet.__init__`)
   - 读取配置文件 `f16_traj_track.py`
   - 创建3架F16飞机（可在配置文件中修改数量）
   - 每架飞机包含：
     - F16动力学模型
     - 位置控制器
     - 3D可视化器

2. **仿真循环** (`Fleet.step`)
   ```
   k=0~49步: 起飞加速阶段
   k=50步: 生成轨迹（自动生成爬升-转弯-下降轨迹）
   k=51~60000步: 轨迹跟踪控制
   ```
   
   每步执行：
   - 获取当前状态（位置、姿态、速度）
   - 计算期望轨迹点
   - 位置控制器计算控制指令（roll, pitch, yaw, throttle）
   - 执行控制指令（内部循环12次）
   - 更新可视化

3. **结果显示** (仿真结束后)
   - 每架飞机的调试图（4个子图）
   - 所有飞机的3D航迹图
   - (可选) 动画回放

### 方式2：单架F16可视化仿真

```bash
python main_F16_run_viz.py
```

单架飞机的详细仿真，适合调试控制器参数。

## 📊 可视化说明

### 实时可视化（realtime=True）

运行时会弹出 **3个窗口**（每架飞机独立）：

1. **局部视角 (Local View)**
   - 显示飞机姿态（机体几何模型）
   - 相机跟随飞机移动
   - 显示局部轨迹

2. **全局视角 (Global View)**
   - 蓝色虚线：实际轨迹
   - 红色虚线：期望轨迹
   - 红色点：当前位置

3. **位置误差 (Position Error RT)**
   - X轴误差（North方向）
   - Y轴误差（East方向）
   - Z轴误差（Down方向，高度）

### 最终调试图（仿真结束后）

**图1：全局航迹 (Global Trajectory)**
- 蓝色：实际轨迹
- 红色：期望轨迹

**图2：控制器调试 (Position Controller Debug)** - 4个子图：

```
子图1: 位置误差 [m]
  - North误差（蓝色）
  - East误差（橙色）
  - Down误差（绿色）

子图2: 速度误差 [m/s]
  - Vn误差
  - Ve误差
  - Vd误差

子图3: 控制加速度 [m/s²]
  - ax（前向加速度）
  - ay（侧向加速度）
  - az（垂向加速度）

子图4: 姿态指令 + 油门
  - roll指令（滚转角，度）
  - pitch指令（俯仰角，度）
  - yaw指令（航向角，度）
  - throttle指令（油门，0-1，黑色线，右Y轴）
```

**图3：油耗曲线 (Fuel Consumption)**
- 绿色线：剩余燃油 [lbs]

## ⚙️ 配置文件说明

`jsb_gym/TAU/config/f16_traj_track.py`

### 关键参数：

```python
# 仿真时间步长
dt = 0.05  # 秒

# 飞机数量
num_aircraft = 3

# 初始状态
init_state = {
    'aircraft1': {
        'lat': 32.0,      # 纬度
        'lon': 45.0,      # 经度
        'alt': 3000,      # 高度 [米]
        'vel': 220,       # 速度 [m/s]
        'heading': 0      # 航向 [度]
    },
    # ...
}

# 位置控制器增益
pid_pos_ctrl = {
    'kpx': 0.125,         # X方向位置增益
    'kpy': 0.125,         # Y方向位置增益
    'kvx': 0.2,           # X方向速度增益
    'kvy': 0.2,           # Y方向速度增益
    'HEIGHT_K_P': 0.01,   # 高度比例增益
    'HEIGHT_K_I': 0.005,  # 高度积分增益
    'max_roll': 0.7,      # 最大滚转角 [rad]
    'max_pitch': 1.0,     # 最大俯仰角 [rad]
}
```

## 🎮 使用技巧

### 1. 调整可视化模式

**实时可视化（适合短时间仿真）：**
```python
fleet = Fleet(conf=cfg, realtime=True, record_debug=True)
```

**离线模式（适合长时间仿真）：**
```python
fleet = Fleet(conf=cfg, realtime=False, record_debug=True)
# 仿真完成后一次性显示
```

### 2. 修改飞机数量

编辑 `f16_traj_track.py`：
```python
num_aircraft = 5  # 改成你想要的数量

# 添加对应的初始状态
init_state = {
    'aircraft4': {...},
    'aircraft5': {...},
}
```

### 3. 修改轨迹参数

在 `Fleet.step()` 中（第54行）：
```python
ac.build_traj(pos, vel,
              leg_lenth_ref=10_000,  # 直线段长度 [米]
              h_ref=400,             # 高度变化 [米]
              v_ref=220)             # 参考速度 [m/s]
```

### 4. 调试控制器

- 查看实时误差窗口
- 调整 `pid_pos_ctrl` 参数
- 重新运行观察效果

### 5. 性能优化

如果仿真太慢：
- 设置 `realtime=False`（关闭实时显示）
- 减少仿真步数 `k_max`
- 减少飞机数量

## 🐛 常见问题

### Q1: 报错 `'FixWingVisualizer' object has no attribute 'show'`

**原因**：旧版本的 API 已更改

**解决**：
- ✅ 使用 `viz.step()` 或让 `set_state()` 自动调用
- ✅ 使用 `viz.show_final()` 显示最终调试图
- ❌ 不要使用 `viz.show()`

### Q2: 没有实时可视化窗口

**检查**：
```python
# 确保 realtime=True
viz = FixWingVisualizer(A=1000, dt=dt, realtime=True)
```

### Q3: 没有控制误差图

**检查**：
```python
# 1. 确保 record_debug=True
viz = FixWingVisualizer(..., record_debug=True)

# 2. 仿真结束后调用
viz.set_ctrl_data(pos_ctrl.get_log_data())
viz.show_final()
```

### Q4: matplotlib 窗口卡死

- 关闭部分窗口（只保留必要的）
- 减小仿真步数
- 使用非交互式后端

## 📝 代码调用关系

```
main_multi_f16.py
    └─> Fleet.__init__()
        └─> AircraftUnit()
            ├─> F16() - 飞行动力学
            ├─> PositionController() - 位置控制
            └─> FixWingVisualizer() - 可视化
    
    └─> Fleet.step(k)
        ├─> ac.get_pos_ned() - 获取状态
        ├─> ac.build_traj() - 生成轨迹 (k=50)
        ├─> ac.traj.get_minco_pva() - 获取期望值
        ├─> ac.pos_ctrl.update() - 计算控制
        ├─> ac.f16.set_xxx_PID() - 设置指令
        ├─> ac.f16.fdm.run() - 运行动力学
        └─> ac.viz.set_state() - 更新可视化
    
    └─> Fleet.show_all_final()
        └─> viz.show_final() - 显示调试图
```

## 🎯 快速开始

```bash
# 1. 运行3架F16编队仿真（实时可视化）
python main_multi_f16.py

# 2. 如果只想看最终结果（更快）
# 编辑 main_multi_f16.py，将 realtime=True 改为 False

# 3. 单架飞机调试
python main_F16_run_viz.py
```

祝你使用愉快！🛩️


